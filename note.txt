---

## Phase 5: n8n Workflow Configuration

### n8n Workflow for Receiving Messages

Create this workflow in n8n:

**Workflow Structure:**

Webhook Trigger
â†“
Extract Data (Code Node)
â†“
Check Message Type (IF Node)
â†“
Process Message (AI/Business Logic)
â†“
Format Response (Code Node)
â†“
Send Response Back (Respond to Webhook)

### Node 1: Webhook Trigger
```javascript
// Configuration
{
  "httpMethod": "POST",
  "path": "chat-message",
  "responseMode": "responseNode"
}
```

### Node 2: Extract Data (Code Node)
```javascript
// Extract message data from web chat format
const body = $json;

// Check if it's from web chat
if (body.source === 'web_chat') {
  const message = body.entry[0].changes[0].value.messages[0];
  const contact = body.entry[0].changes[0].value.contacts[0];
  
  return {
    json: {
      messageId: message.id,
      userId: body.user.id,
      userName: body.user.name,
      userPhone: body.user.phone,
      messageText: message.text.body,
      timestamp: parseInt(message.timestamp),
      sessionId: body.sessionId,
      source: 'web',
      rawData: body
    }
  };
}

// Default return for other sources
return {
  json: body
};
```

### Node 3: AI Processing (HTTP Request to OpenAI)
```javascript
// HTTP Request Node Configuration
{
  "method": "POST",
  "url": "https://api.openai.com/v1/chat/completions",
  "authentication": "headerAuth",
  "headers": {
    "Authorization": "Bearer {{$env.OPENAI_API_KEY}}",
    "Content-Type": "application/json"
  },
  "body": {
    "model": "gpt-4",
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful AI assistant for courier booking. Help users book shipments by collecting: pickup address, delivery address, pickup phone, delivery phone."
      },
      {
        "role": "user",
        "content": "{{$json.messageText}}"
      }
    ],
    "temperature": 0.7,
    "max_tokens": 500
  }
}
```

### Node 4: Format Response (Code Node)
```javascript
// Format response in WhatsApp message format
const aiResponse = $json.choices[0].message.content;
const originalMessage = $node["Extract Data"].json;

const responsePayload = {
  object: 'whatsapp_business_account',
  entry: [{
    id: 'n8n_bot',
    changes: [{
      value: {
        messaging_product: 'whatsapp',
        metadata: {
          display_phone_number: 'AI Assistant',
          phone_number_id: 'bot_assistant'
        },
        contacts: [{
          profile: {
            name: 'AI Assistant'
          },
          wa_id: 'bot_assistant'
        }],
        messages: [{
          from: 'bot_assistant',
          id: `msg_${Date.now()}`,
          timestamp: Date.now().toString(),
          text: {
            body: aiResponse
          },
          type: 'text'
        }]
      },
      field: 'messages'
    }]
  }]
};

return {
  json: responsePayload
};
```

### Node 5: Respond to Webhook
```javascript
// Respond to Webhook Node
{
  "respondWith": "json",
  "responseBody": "={{$json}}"
}
```

---

## Phase 6: Testing the Complete System

### Test 1: Start the React App
```bash
cd whatsapp-web-clone
npm start
```

The app should open at `http://localhost:3000`

### Test 2: Send a Test Message

1. Type a message in the input field
2. Click send or press Enter
3. Check browser console for logs
4. Check n8n workflow executions

### Test 3: Verify n8n Receives Data

In n8n, you should see executions with data like:
```json
{
  "messageId": "msg_1234567890_abc123",
  "userId": "user_12345",
  "userName": "You",
  "userPhone": "+919876543210",
  "messageText": "I want to book a courier",
  "timestamp": 1705334400000,
  "sessionId": "session_1705334400000_xyz789",
  "source": "web"
}
```

### Test 4: Verify Response Back to UI

The React app should receive and display the bot's response in the chat.

---

## Phase 7: Advanced Features

### Feature 1: Typing Indicator

**Add to `ChatWindow.jsx`:**
```javascript
import React, { useState, useEffect } from 'react';

const ChatWindow = ({ chat, onBack }) => {
  const [isTyping, setIsTyping] = useState(false);
  
  // Show typing indicator when waiting for response
  const handleSendMessage = async (text) => {
    if (text.trim()) {
      setIsTyping(true);
      await sendMessage(chat.id, text);
      
      // Remove typing indicator after response
      setTimeout(() => setIsTyping(false), 2000);
    }
  };

  return (
    <div className="chat-window">
      <ChatHeader chat={chat} onBack={onBack} />
      <MessageList messages={chatMessages} chat={chat} />
      {isTyping && <TypingIndicator />}
      <MessageInput onSend={handleSendMessage} />
    </div>
  );
};
```

**Create `TypingIndicator.jsx`:**
```javascript
import React from 'react';
import './TypingIndicator.css';

const TypingIndicator = () => {
  return (
    <div className="typing-indicator">
      <div className="typing-bubble">
        <div className="typing-dot"></div>
        <div className="typing-dot"></div>
        <div className="typing-dot"></div>
      </div>
    </div>
  );
};

export default TypingIndicator;
```

**`TypingIndicator.css`:**
```css
.typing-indicator {
  display: flex;
  padding: 0 8%;
  margin-bottom: 12px;
}

.typing-bubble {
  background: #202c33;
  padding: 12px 16px;
  border-radius: 7.5px;
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background: #8696a0;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}
```

### Feature 2: Message Reactions

**Update `Message.jsx`:**
```javascript
const Message = ({ message, showAvatar, chat }) => {
  const [showReactions, setShowReactions] = useState(false);
  const [reaction, setReaction] = useState(message.reaction);

  const reactions = ['â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™', 'ðŸ‘'];

  const handleReaction = (emoji) => {
    setReaction(emoji);
    setShowReactions(false);
    // Update in context
  };

  return (
    <div 
      className={`message ${isSent ? 'message-sent' : 'message-received'}`}
      onContextMenu={(e) => {
        e.preventDefault();
        setShowReactions(true);
      }}
    >
      {/* ... existing message content ... */}
      
      {showReactions && (
        <div className="reaction-picker">
          {reactions.map(emoji => (
            <button
              key={emoji}
              onClick={() => handleReaction(emoji)}
              className="reaction-button"
            >
              {emoji}
            </button>
          ))}
        </div>
      )}
      
      {reaction && (
        <div className="message-reaction">
          {reaction}
        </div>
      )}
    </div>
  );
};
```

### Feature 3: Search Messages

**Add to `Sidebar.jsx`:**
```javascript
const [searchMessages, setSearchMessages] = useState('');
const [searchResults, setSearchResults] = useState([]);

const handleSearchMessages = (query) => {
  setSearchMessages(query);
  
  if (!query.trim()) {
    setSearchResults([]);
    return;
  }

  // Search through all messages
  const results = [];
  Object.entries(messages).forEach(([chatId, chatMessages]) => {
    chatMessages.forEach(msg => {
      if (msg.text.toLowerCase().includes(query.toLowerCase())) {
        results.push({
          ...msg,
          chatId,
          chatName: chats.find(c => c.id === chatId)?.name
        });
      }
    });
  });
  
  setSearchResults(results);
};
```

---

## Phase 8: Deployment

### Deploy React App

**Option 1: Vercel**
```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
vercel

# Set environment variables in Vercel dashboard
```

**Option 2: Netlify**
```bash
# Build the app
npm run build

# Deploy to Netlify
# Drag and drop the build folder to netlify.com
```

**Option 3: GitHub Pages**
```bash
# Install gh-pages
npm install --save-dev gh-pages

# Add to package.json
{
  "homepage": "https://yourusername.github.io/whatsapp-web-clone",
  "scripts": {
    "predeploy": "npm run build",
    "deploy": "gh-pages -d build"
  }
}

# Deploy
npm run deploy
```

### Update n8n Webhook CORS

In n8n, add CORS headers to allow your deployed React app:
```javascript
// In n8n webhook response node, add headers:
{
  "Access-Control-Allow-Origin": "https://your-app.vercel.app",
  "Access-Control-Allow-Methods": "POST, GET, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type"
}
```

---

## Complete Package.json

**`package.json`:**
```json
{
  "name": "whatsapp-web-clone",
  "version": "1.0.0",
  "description": "WhatsApp Web Clone with n8n Integration",
  "private": true,
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-scripts": "5.0.1",
    "axios": "^1.6.0",
    "emoji-picker-react": "^4.5.16",
    "react-icons": "^4.12.0",
    "date-fns": "^2.30.0",
    "uuid": "^9.0.1"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  }
}
```

---

## Complete Flow Diagram